<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mosaver</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      overflow: hidden;
      height: 100vh;
      touch-action: pan-y;
      background: #f5f5f5;
      opacity: 0;
      transition: opacity 0.3s ease-in;
    }
    .header {
      background: linear-gradient(90deg, #075e54, #128C7E);
      color: white;
      padding: 15px 20px;
      font-weight: bold;
      font-size: 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title {
      font-weight: bold;
      font-size: 20px;
      color: white;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
    }
    .menu-toggle {
      background: none; border: none; color: white; font-size: 24px; cursor: pointer;
      min-width: 40px;
      display: flex;
      justify-content: flex-end;
    }
    .sidebar {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 300px;
      height: calc(100% - 60px);
      background: white;
      box-shadow: -4px 0 15px rgba(0,0,0,0.1);
      z-index: 2000;
      transition: right 0.4s ease;
      padding: 20px;
      overflow-y: auto;
    }
    .sidebar.open { right: 0; }
    .sidebar h3 { color: #075e54; margin-bottom: 20px; }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .form-group input:focus {
      border-color: #128C7E;
      box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.2);
      outline: none;
    }
    .btn {
      background: #075e54;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    .btn:hover { background: #054a43; transform: translateY(-2px); }
    .btn-outline {
      background: transparent;
      border: 2px solid #075e54;
      color: #075e54;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    .register-type {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .register-type button {
      flex: 1;
      padding: 12px;
      font-weight: bold;
      border-radius: 12px;
    }
    .section { margin-top: 30px; }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #075e54;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e0e0e0;
    }
    .map-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5;
    }
    #map { width: 100%; height: 100%; }
    #permissionScreen {
      position: fixed;
      top: 60px; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 100;
    }
    #permissionScreen h2 { color: #075e54; margin: 15px 0; font-size: 24px; }
    #permissionScreen p { color: #444; line-height: 1.7; margin: 15px 0; max-width: 380px; }
    .requirement {
      background: #e8f5e9;
      border-right: 4px solid #4caf50;
      padding: 12px;
      margin: 12px 0;
      border-radius: 0 8px 8px 0;
      text-align: right;
    }
    #allowBtn {
      background: #075e54;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 14px 36px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(7, 94, 84, 0.4);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    #allowBtn:hover:not(:disabled) { background: #054a43; transform: translateY(-2px); }
    #allowBtn:disabled { opacity: 0.7; transform: none !important; }
    .control-btns {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: none;
    }
    .driver-info-card {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 -4px 30px rgba(0,0,0,0.25);
      z-index: 999;
      display: none;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { bottom: -200px; opacity: 0; }
      to { bottom: 20px; opacity: 1; }
    }
    .driver-info-card h4 {
      color: #075e54;
      margin: 0 0 15px;
      text-align: center;
    }
    .driver-info-card p {
      margin: 8px 0;
      color: #555;
    }
    .id-card-line {
      margin: 8px 0;
      color: #555;
    }
    .driver-info-card .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: center;
    }
    .btn-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: none;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }
    .btn-icon::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: scale(0);
      transition: transform 0.4s ease;
    }
    .btn-icon:hover::before {
      transform: scale(1.8);
    }
    .btn-chat {
      background: #128C7E;
    }
    .btn-call {
      background: #2196F3;
    }
    .btn-icon:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .btn-icon:active {
      transform: translateY(0) scale(0.98);
    }
    .btn-icon i {
      position: relative;
      z-index: 2;
      transition: transform 0.2s ease;
    }
    .btn-icon:hover i {
      transform: scale(1.1);
    }
    .btn-call.disabled {
      background: #9E9E9E !important;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    .btn-call.disabled i {
      opacity: 0.6;
    }
    .alert {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
    }
    .alert-success { 
      background: #e8f5e9; 
      color: #2e7d32; 
      border-right: 3px solid #4caf50;
    }
    .alert-error { 
      background: #ffebee; 
      color: #c62828; 
      border-right: 3px solid #f44336;
    }
    .register-modal {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 300px;
      height: calc(100% - 60px);
      background: white;
      box-shadow: -4px 0 15px rgba(0,0,0,0.2);
      z-index: 2500;
      transition: right 0.4s ease;
      padding: 20px;
      overflow-y: auto;
    }
    .register-modal.open {
      right: 0;
    }
    .modal-title {
      color: #075e54;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
    }
    .chat-modal {
      position: fixed;
      bottom: -500px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 400px;
      height: 450px;
      background: white;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      transition: bottom 0.3s ease;
    }
    .chat-modal.open {
      bottom: 0;
    }
    .chat-header {
      background: linear-gradient(90deg, #075e54, #128C7E);
      color: white;
      padding: 15px;
      border-radius: 15px 15px 0 0;
      text-align: center;
      position: relative;
    }
    .chat-header h4 {
      margin: 0;
      font-size: 16px;
    }
    .close-chat {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    #chatDriverInfo {
      font-size: 12px;
      margin-top: 5px;
      opacity: 0.9;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .message.sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    .message.received {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-time {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
      text-align: right;
    }
    .chat-input {
      display: flex;
      padding: 15px;
      background: white;
      border-top: 1px solid #e0e0e0;
      gap: 10px;
    }
    .chat-input input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
    }
    .chat-input input:focus {
      border-color: #128C7E;
    }
    .chat-input button {
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-input button:hover {
      background: #075e54;
    }
    .chat-input button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .chat-toggle-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    .chat-toggle-btn:hover {
      background: #075e54;
      transform: scale(1.05);
    }
    .chat-badge-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 2px solid white;
      display: none;
    }
    .user-marker {
      background: #075e54;
      border: 2px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      font-weight: bold;
    }
    .driver-marker {
      background: #ff9800;
      border: 3px solid white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      font-weight: bold;
    }
    .typing-indicator {
      font-style: italic;
      color: #666;
      font-size: 12px;
      padding: 5px 15px;
    }
    .refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(7, 94, 84, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    .field-error {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    input:valid {
      border-color: #4CAF50 !important;
    }
    input:invalid:not(:focus):not(:placeholder-shown) {
      border-color: #f44336 !important;
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    @media (max-width: 768px) {
      .sidebar, .register-modal {
        width: 300px;
        right: -300px;
      }
      .driver-info-card {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div style="flex: 1;"></div>
    <div class="header-title">Mosaver</div>
    <div style="flex: 1; display: flex; justify-content: flex-end;">
      <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>
  <div class="refresh-indicator" id="refreshIndicator">
    <i class="fas fa-sync-alt fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...
  </div>
  <aside class="sidebar" id="sidebar">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <div id="authSection">
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="email" placeholder="example@gmail.com">
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      </div>
      <button class="btn" id="loginBtn">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <div class="register-type">
        <button class="btn btn-outline" id="registerDriverBtn">
          ğŸš– Ø³Ø§Ø¦Ù‚
        </button>
        <button class="btn btn-outline" id="registerUserBtn">
          ğŸ‘¤ Ø²Ø¨ÙˆÙ†
        </button>
      </div>
    </div>
    <div id="userProfileSection" style="display:none;">
      <div class="alert alert-success" id="welcomeMsg">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="userName"></span>!</div>
      <button class="btn btn-outline" id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      <div class="section">
        <button class="btn" id="startTrackingBtn" style="display:none;">ğŸ“ ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      </div>
    </div>
  </aside>
  <!-- Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <div id="registerDriverModal" class="register-modal">
    <button class="close-modal" id="closeRegisterDriverModal">&times;</button>
    <div class="modal-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚</div>
    <div class="form-group">
      <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="regDriverName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
    </div>
    <div class="form-group">
      <label><i class="fas fa-id-card"></i> Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© / Ø§Ù„Ø±Ø®ØµØ©</label>
      <input type="text" id="regDriverIdCard" placeholder="12345678">
    </div>
    <div class="form-group">
      <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input type="tel" id="regDriverPhone" placeholder="46XXXXXX">
    </div>
    <div class="form-group">
      <label><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="regDriverEmail" placeholder="example@gmail.com">
    </div>
    <div class="form-group">
      <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="regDriverPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <div class="form-group">
      <input type="checkbox" id="driverTermsCheck" required>
      <label for="driverTermsCheck">
        Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŒ ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø¹Ø¯Ù… ØªØ¹Ø±ÙŠØ¶ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£ÙŠ Ø®Ø·Ø±.
      </label>
    </div>
    <button class="btn" id="submitDriverRegister">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
  </div>
  <div id="registerUserModal" class="register-modal">
    <button class="close-modal" id="closeRegisterUserModal">&times;</button>
    <div class="modal-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø²Ø¨ÙˆÙ†</div>
    <div class="form-group">
      <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="regUserName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
    </div>
    <div class="form-group">
      <label><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="regUserEmail" placeholder="example@gmail.com">
    </div>
    <div class="form-group">
      <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="regUserPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>
    <button class="btn" id="submitUserRegister">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="chatModal" class="chat-modal">
    <div class="chat-header">
      <button class="close-chat" id="closeChat">&times;</button>
      <h4>ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ <span id="chatPartnerName">---</span></h4>
      <div id="chatPartnerInfo"></div>
      <div id="typingIndicator" class="typing-indicator" style="display:none;">
        <i class="fas fa-pencil-alt"></i> <span id="typingUserName">---</span> ÙŠÙƒØªØ¨...
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div style="text-align:center;color:#888;margin-top:20px;">Ø§ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±</div>
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." maxlength="500">
      <button id="sendMessageBtn">ğŸ“¤</button>
    </div>
  </div>
  <button class="chat-toggle-btn" id="chatToggleBtn">
    <i class="fas fa-comments"></i>
    <span class="chat-badge-count" id="chatBadgeCount">0</span>
  </button>
  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø°Ù† -->
  <div id="permissionScreen">
    <div class="emoji">ğŸ“</div>
    <h2>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨</h2>
    <p>Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ ÙŠØ¬Ø¨ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.</p>
    <div class="requirement">âœ… Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
    <div class="requirement">âœ… Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡ Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡</div>
    <div class="requirement">âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§ÙÙ‡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª</div>
    <button id="allowBtn">
      <span class="emoji">ğŸ§­</span> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†
    </button>
  </div>
  <main class="map-container" id="mapContainer" style="display:none;">
    <div id="map"></div>
  </main>
  <div class="control-btns" id="controlBtns">
    <button class="btn" id="requestBtn">
      <span class="emoji">ğŸš•</span> Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ
    </button>
  </div>
  <div class="driver-info-card" id="userInfoCard">
    <h4 id="cardUserName">--- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---</h4>
    <p class="id-card-line" id="idCardLine"></p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="cardUserPhone">---</span></p>
    <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> <span class="user-distance" id="cardDistanceText">--</span></p>
    <div class="btn-group">
      <button class="btn-icon btn-chat" id="cardChatBtn" title="Ø¯Ø±Ø¯Ø´Ø©">
        <i class="fas fa-comment-dots"></i>
      </button>
      <a class="btn-icon btn-call" id="cardCallBtn" href="#" title="Ù…ÙƒØ§Ù„Ù…Ø©">
        <i class="fas fa-phone-alt"></i>
      </a>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCd72265mC_yNPAXYl-8jXxJgZk-afC7Y4",
      authDomain: "ryada-6773b.firebaseapp.com",
      projectId: "ryada-6773b",
      storageBucket: "ryada-6773b.firebasestorage.app",
      messagingSenderId: "567927086495",
      appId: "1:567927086495:web:1cf92498647022f017b1aa",
      measurementId: "G-F08ZYR9FTH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let map = null;
    let userMarker = null;
    let userLatLng = null;
    let trackingInterval = null;
    let userMarkers = new Map();
    let currentChatRoom = null;
    let chatUnsubscribe = null;
    let currentChatPartner = null;
    let lastLocationUpdate = 0;
    let currentUserRole = null;
    let typingTimeout = null;
    let isLocationEnabled = false;
    let notificationSound = null;
    let isSoundEnabled = true;
    const DEFAULT_PRIVACY_SETTINGS = {
      shareLocation: true,
      showProfile: true,
      allowChat: true,
      onlineStatus: true
    };
    const loadingManager = {
      show: function(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
        const loader = document.createElement('div');
        loader.id = 'globalLoader';
        loader.innerHTML = `
          <div style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;">
            <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
              <div class="fas fa-spinner fa-spin" style="font-size:24px; color:#075e54; margin-bottom:10px;"></div>
              <div style="color:#333; font-weight:500;">${message}</div>
            </div>
          </div>
        `;
        document.body.appendChild(loader);
      },
      hide: function() {
        const loader = document.getElementById('globalLoader');
        if (loader) loader.remove();
      }
    };
    const notificationManager = {
      show: function(title, message, type = 'info', duration = 4000) {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? '#4CAF50' : 
                       type === 'error' ? '#f44336' : 
                       type === 'warning' ? '#ff9800' : '#2196F3';
        notification.innerHTML = `
          <div style="position:fixed; top:80px; right:20px; background:white; padding:15px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15); border-right:4px solid ${bgColor}; z-index:10000; max-width:350px; min-width:300px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="color:${bgColor}; font-size:18px;">
                ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}
              </div>
              <div style="flex:1;">
                <div style="font-weight:bold; color:#333; margin-bottom:5px;">${title}</div>
                <div style="color:#666; font-size:14px;">${message}</div>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:#999; cursor:pointer; padding:5px;">âœ•</button>
            </div>
          </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
          if (notification.parentNode) notification.remove();
        }, duration);
      }
    };
    function initializeNotificationSound() {
      try {
        notificationSound = new Audio();
        notificationSound.src = "data:audio/wav;base64,UklGRqQPAABXQVZFZm10IBAAAAABAAEAiBUAAIgVAAABABAAZGF0YQAPAACBhYqFbF1fdJq4qYJhUnOSu7eTaF+Au9K4j2hfgLTQ0LWOaF1+sdDMs4poXX2vzsy0jGhcearJybGJaFx3p8fHrYlnXXSmw8Gni2hcdKTAvqaJaFxzobu8pYpoXHGfurmmiWhcb566uKWJaFxtnbq2oIhnXGucuLOci2hcaZu3sp6JaFxnmLGtnYpoXGabrqyZiWhcZJmtrJeJaFxjlqiok4lmXGCZq6eRiWZcX5iwo4+JZlxfmLGjjoZoXF6YsqKJZlxfmbOihmZcX5m0ooRoXF+btqF+ZlxfmraheGZcX5u4oHZmXF+cuqBzZlxfnbqgcGZcX568n25mXF+fvqBtZlxfn7+fa2ZcX6CAnGpmXF+foIJnZlxfn6GDaGZcX6GjgWNmXF+hooJhZlxfocB/WmZcX6LgflhmXF+hwX9UZlxfocF+UWZcX6HBfU9mXF+iwnxNZlxfosN8S2ZcX6PDfEhmXF+jxHtGZlxfpMZ7Q2ZcX6TGfUBmXF+lyXo7Zlxfpsx6OmZcX6bOejhmXF+n0Hk1Zlxfp9J5M2ZcX6fUeTBmXF+n1XkuZlxfp9Z5LWZcX6jYdStmXF+o2nUpZlxfqNt1J2ZcX6ncdSNmXF+p3nUhZlxfqd91HmZcX6rhdRtmXF+r43UVZlxfq+V1EWZcX6vodQ9mXF+t6XUEZlxfre11/mVcX67vdflkXF+v8HbiY1xfscN22mJcX7LGdsRhXF+zyXa/YFxfss52uV5cX7PRdqldXF+01XanXFxf";
        notificationSound.volume = 0.5;
      } catch (e) {
        console.warn('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', e);
        notificationSound = null;
      }
    }
    function playNotificationSound() {
      return;
    }
    const chatManager = {
      typingIndicator: function(roomId, isTyping) {
        if (!roomId) return;
        db.collection('chats').doc(roomId).update({
          [`typing.${auth.currentUser.uid}`]: isTyping,
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    };
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function toLatLng(loc) {
      if (!loc) return null;
      return L.latLng(loc.latitude || loc.lat, loc.longitude || loc.lng);
    }
    async function checkUserPermission(requiredRole = null) {
      const user = auth.currentUser;
      if (!user) throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists) throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      const userData = userDoc.data();
      if (requiredRole && userData.role !== requiredRole) {
        throw new Error('ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡');
      }
      return userData;
    }
    async function updateUserLocation(uid, location) {
      try {
        await checkUserPermission();
        await db.collection('users').doc(uid).update({
          location: {
            latitude: location.latitude,
            longitude: location.longitude,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          },
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          privacySettings: DEFAULT_PRIVACY_SETTINGS,
          isVisible: true
        });
      } catch (error) {
        console.error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
      }
    }
    let locationUpdateQueue = [];
    let isUpdatingLocation = false;
    async function optimizedLocationUpdate(location) {
      locationUpdateQueue.push(location);
      if (!isUpdatingLocation) {
        isUpdatingLocation = true;
        while (locationUpdateQueue.length > 0) {
          const latestLocation = locationUpdateQueue[locationUpdateQueue.length - 1];
          locationUpdateQueue = [];
          try {
            await updateUserLocation(auth.currentUser.uid, latestLocation);
          } catch (error) {
            console.error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
          }
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        isUpdatingLocation = false;
      }
    }
    async function enableLocationAndInitMap() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ'));
          return;
        }
        loadingManager.show('Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            try {
              const { latitude, longitude } = position.coords;
              userLatLng = { latitude, longitude };
              document.getElementById('permissionScreen').style.display = 'none';
              document.getElementById('mapContainer').style.display = 'block';
              if (!map) {
                map = L.map('map').setView([latitude, longitude], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                const userIcon = L.divIcon({ 
                  html: '<div class="user-marker">ğŸ‘¤</div>', 
                  className: 'user-marker-icon',
                  iconSize: [24, 24],
                  iconAnchor: [12, 12]
                });
                userMarker = L.marker([latitude, longitude], {
                  title: 'Ù…ÙˆÙ‚Ø¹Ùƒ',
                  icon: userIcon,
                  zIndexOffset: 1000
                }).addTo(map);
                setTimeout(() => { if (map) map.invalidateSize(); }, 300);
              } else {
                userMarker.setLatLng([latitude, longitude]);
                map.setView([latitude, longitude], 14);
                setTimeout(() => { if (map) map.invalidateSize(); }, 100);
              }
              startLocationTracking();
              await loadActiveUsersOnMap();
              isLocationEnabled = true;
              resolve();
            } catch (error) {
              reject(error);
            } finally {
              loadingManager.hide();
            }
          },
          (error) => {
            loadingManager.hide();
            let msg = 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
            if (error.code === error.PERMISSION_DENIED) msg = 'ÙŠØ±Ø¬Ù‰ ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­';
            else if (error.code === error.POSITION_UNAVAILABLE) msg = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ± â€” ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS';
            else if (error.code === error.TIMEOUT) msg = 'Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â€” Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§';
            reject(new Error(msg));
          },
          { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
        );
      });
    }
    function startLocationTracking() {
      if (trackingInterval) {
        navigator.geolocation.clearWatch(trackingInterval);
      }
      trackingInterval = navigator.geolocation.watchPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          userLatLng = { latitude, longitude };
          if (userMarker) {
            userMarker.setLatLng([latitude, longitude]);
          }
          const now = Date.now();
          if (now - lastLocationUpdate > 10000) {
            lastLocationUpdate = now;
            const user = auth.currentUser;
            if (user) {
              await optimizedLocationUpdate({ latitude, longitude });
            }
          }
        },
        (error) => {
          console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
          notificationManager.show('ØªØ­Ø°ÙŠØ±', 'ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'warning');
        },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
      );
    }
    async function loadActiveUsersOnMap() {
      if (!map) return;
      try {
        document.getElementById('refreshIndicator').style.display = 'block';
        const cutoff = firebase.firestore.Timestamp.fromMillis(Date.now() - 120000);
        const usersSnapshot = await db.collection('users')
          .where('location.timestamp', '>=', cutoff)
          .limit(50)
          .get();
        const currentUser = auth.currentUser;
        userMarkers.forEach(marker => marker.remove());
        userMarkers.clear();
        if (usersSnapshot.empty) {
          document.getElementById('refreshIndicator').style.display = 'none';
          return;
        }
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          if (!user.location?.latitude || !user.role || user.uid === currentUser?.uid) return;
          const userLatLng = toLatLng(user.location);
          const distanceKm = calculateDistance(
            userLatLng.lat,
            userLatLng.lng,
            user.location.latitude,
            user.location.longitude
          );
          const isDriver = user.role === 'driver';
          const userIconHTML = isDriver 
            ? `<div class="driver-marker">ğŸš•</div>` 
            : `<div class="user-marker">ğŸ‘¤</div>`;
          const userIcon = L.divIcon({ 
            html: userIconHTML,
            className: isDriver ? 'driver-marker-icon' : 'user-marker-icon',
            iconSize: isDriver ? [28, 28] : [24, 24],
            iconAnchor: isDriver ? [14, 14] : [12, 12]
          });
          const marker = L.marker(userLatLng, { icon: userIcon }).addTo(map)
            .bindTooltip(`<b>${user.name}</b><br>${isDriver ? 'Ø³Ø§Ø¦Ù‚' : 'Ø²Ø¨ÙˆÙ†'} - ${distanceKm.toFixed(1)} ÙƒÙ…`, {
              permanent: false,
              direction: 'top'
            });
          marker.on('click', () => showUserInfoCard(user, distanceKm));
          userMarkers.set(user.uid, marker);
        });
        document.getElementById('refreshIndicator').style.display = 'none';
      } catch (error) {
        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
        document.getElementById('refreshIndicator').style.display = 'none';
        notificationManager.show('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      }
    }
    function showUserInfoCard(user, distanceKm) {
      if (!isLocationEnabled) {
        notificationManager.show('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      const card = document.getElementById('userInfoCard');
      document.getElementById('cardUserName').textContent = user.name || '---';
      const idCardLine = document.getElementById('idCardLine');
      const phoneEl = document.getElementById('cardUserPhone');
      const phoneParent = phoneEl.parentElement;
      const isDriver = user.role === 'driver';
      if (isDriver) {
        idCardLine.innerHTML = `<strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> ${user.idCard || '---'}`;
        idCardLine.style.display = 'block';
        phoneEl.textContent = user.phone || '---';
        phoneParent.style.display = 'block';
        const callBtn = document.getElementById('cardCallBtn');
        if (user.phone) {
          callBtn.href = `tel:${user.phone}`;
          callBtn.classList.remove('disabled');
          callBtn.style.display = 'flex';
        } else {
          callBtn.classList.add('disabled');
          callBtn.style.display = 'flex';
          callBtn.href = '#';
        }
      } else {
        idCardLine.style.display = 'none';
        phoneParent.style.display = 'none';
        document.getElementById('cardCallBtn').style.display = 'none';
      }
      document.getElementById('cardDistanceText').textContent = `${distanceKm.toFixed(1)} ÙƒÙ…`;
      document.getElementById('cardChatBtn').onclick = () => {
        openChatWithUser(user);
        card.style.display = 'none';
      };
      card.style.display = 'block';
    }
    function smoothPanTo(location) {
      if (!map || !location) return;
      const currentZoom = map.getZoom();
      const targetZoom = currentZoom > 15 ? currentZoom : 16;
      map.flyTo([location.lat, location.lng], targetZoom, {
        duration: 1.5,
        easeLinearity: 0.3,
        noMoveStart: true
      });
    }
    async function findNearestDriver() {
      if (!userLatLng || !map) return null;
      const cutoff = firebase.firestore.Timestamp.fromMillis(Date.now() - 120000);
      const driversSnapshot = await db.collection('users')
        .where('role', '==', 'driver')
        .where('location.timestamp', '>=', cutoff)
        .limit(20)
        .get();
      if (driversSnapshot.empty) return null;
      let nearestDriver = null;
      let minDistance = Infinity;
      driversSnapshot.forEach(doc => {
        const driver = doc.data();
        if (!driver.location?.latitude || !driver.location?.longitude) return;
        const driverLatLng = toLatLng(driver.location);
        const distanceKm = calculateDistance(
          userLatLng.latitude,
          userLatLng.longitude,
          driverLatLng.lat,
          driverLatLng.lng
        );
        if (distanceKm < minDistance) {
          minDistance = distanceKm;
          nearestDriver = {
            ...driver,
            distanceKm: distanceKm,
            location: driverLatLng
          };
        }
      });
      return nearestDriver;
    }
    async function openChatWithUser(user) {
      if (!auth.currentUser) {
        notificationManager.show('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      currentChatPartner = user;
      const currentUser = auth.currentUser;
      const uids = [currentUser.uid, user.uid].sort();
      currentChatRoom = uids.join('_');
      const chatRef = db.collection('chats').doc(currentChatRoom);
      const chatDoc = await chatRef.get();
      if (!chatDoc.exists) {
        await chatRef.set({
          participants: uids,
          lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
          typing: {}
        });
      } else {
        await chatRef.update({
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      document.getElementById('chatPartnerName').textContent = user.name || '---';
      document.getElementById('chatPartnerInfo').textContent = `${user.role === 'driver' ? 'Ø³Ø§Ø¦Ù‚' : 'Ø²Ø¨ÙˆÙ†'} - ${user.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§ØªÙ'}`;
      document.getElementById('chatMessages').innerHTML = '<div style="text-align:center;color:#888;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      if (chatUnsubscribe && typeof chatUnsubscribe === 'function') {
        chatUnsubscribe();
        chatUnsubscribe = null;
      }
      chatUnsubscribe = db.collection('chats').doc(currentChatRoom).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot({ includeMetadataChanges: true }, (snapshot) => {
          if (snapshot.metadata.fromCache || snapshot.metadata.hasPendingWrites) return;
          renderMessages(snapshot.docs);
          markMessagesAsRead();
        });
      db.collection('chats').doc(currentChatRoom).onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          if (data && data.typing) {
            const typingUsers = Object.entries(data.typing)
              .filter(([uid, isTyping]) => uid !== auth.currentUser.uid && isTyping);
            if (typingUsers.length > 0) {
              document.getElementById('typingUserName').textContent = user.name;
              document.getElementById('typingIndicator').style.display = 'block';
            } else {
              document.getElementById('typingIndicator').style.display = 'none';
            }
          }
        }
      });
      document.getElementById('chatModal').classList.add('open');
      document.getElementById('messageInput').focus();
      document.getElementById('chatToggleBtn').classList.remove('has-unread');
      document.getElementById('chatBadgeCount').style.display = 'none';
    }
    function renderMessages(messageDocs) {
      const container = document.getElementById('chatMessages');
      const user = auth.currentUser;
      if (!user) return;
      container.innerHTML = '';
      if (messageDocs.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#888;margin-top:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!</div>';
        return;
      }
      messageDocs.forEach(doc => {
        const msg = doc.data();
        if (!msg.text || !msg.sender || !msg.timestamp) return;
        const isSent = msg.sender === user.uid;
        const time = msg.timestamp?.toDate?.() || new Date(msg.timestamp?.seconds ? msg.timestamp.seconds * 1000 : Date.now());
        const timeStr = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        const div = document.createElement('div');
        div.className = `message ${isSent ? 'sent' : 'received'}`;
        div.innerHTML = `<div>${msg.text}</div><div class="message-time">${timeStr}</div>`;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    }
    async function markMessagesAsRead() {
      if (!currentChatRoom || !auth.currentUser || !currentChatPartner) return;
      try {
        const batch = db.batch();
        const ref = db.collection('chats').doc(currentChatRoom).collection('messages');
        const snap = await ref.where('sender', '==', currentChatPartner.uid).where('read', '==', false).get();
        snap.docs.forEach(doc => batch.update(doc.ref, { read: true }));
        if (snap.size > 0) await batch.commit();
        await db.collection('chats').doc(currentChatRoom).update({
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) { 
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:', error); 
      }
    }
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentChatRoom || !auth.currentUser || !currentChatPartner) return;
      const btn = document.getElementById('sendMessageBtn');
      btn.disabled = true;
      try {
        const msgId = db.collection('chats').doc().id;
        const now = firebase.firestore.Timestamp.now();
        chatManager.typingIndicator(currentChatRoom, false);
        await db.collection('chats').doc(currentChatRoom).collection('messages').doc(msgId).set({
          text, 
          sender: auth.currentUser.uid,
          timestamp: now,
          read: false
        });
        await db.collection('chats').doc(currentChatRoom).update({
          lastActivity: now,
          participants: [auth.currentUser.uid, currentChatPartner.uid].sort()
        });
        input.value = '';
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        notificationManager.show('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'error');
      } finally {
        btn.disabled = false;
      }
    }
    function updateUIBasedOnRole(userData) {
      const isDriver = userData?.role === 'driver';
      const isUser = userData?.role === 'user';
      window.currentUserRole = userData?.role;
      const userNameSpan = document.getElementById('userName');
      const startTrackingBtn = document.getElementById('startTrackingBtn');
      const displayName = userData.name || userData.email?.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…';
      userNameSpan.textContent = displayName;
      document.getElementById('welcomeMsg').innerHTML = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <strong>${displayName}</strong>!`;
      if (isUser) {
        document.getElementById('controlBtns').style.display = 'flex';
      } else {
        document.getElementById('controlBtns').style.display = 'none';
      }
      if (auth.currentUser) {
        document.getElementById('chatToggleBtn').style.display = 'flex';
      }
      if (isDriver) {
        startTrackingBtn.style.display = 'block';
      } else {
        startTrackingBtn.style.display = 'none';
      }
    }
    function validateDriverRegistration(data) {
        if (!data.name || data.name.trim().length < 2) return 'Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!data.email || !emailRegex.test(data.email.trim())) return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
        if (!data.password || data.password.length < 6) return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        if (!data.idCard || data.idCard.trim().length < 4) return 'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©/Ø§Ù„Ø±Ø®ØµØ© ØºÙŠØ± ØµØ§Ù„Ø­';
        const phoneRegex = /^[\d\s\-\+]{8,15}$/;
        if (!data.phone || !phoneRegex.test(data.phone.trim())) return 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­';
        if (!data.terms) return 'ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
        return null;
    }
    function validateUserRegistration(data) {
        if (!data.name || data.name.trim().length < 2) return 'Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!data.email || !emailRegex.test(data.email.trim())) return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
        if (!data.password || data.password.length < 6) return 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        return null;
    }
    async function registerDriver() {
        const btn = document.getElementById('submitDriverRegister');
        const originalText = btn.innerHTML;
        try {
            const formData = {
                name: document.getElementById('regDriverName').value.trim(),
                idCard: document.getElementById('regDriverIdCard').value.trim(),
                phone: document.getElementById('regDriverPhone').value.trim(),
                email: document.getElementById('regDriverEmail').value.trim(),
                password: document.getElementById('regDriverPassword').value,
                terms: document.getElementById('driverTermsCheck').checked
            };
            const err = validateDriverRegistration(formData);
            if (err) throw new Error(err);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
            const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
            const user = userCredential.user;
            const userData = {
                uid: user.uid,
                name: formData.name,
                email: formData.email,
                role: 'driver',
                phone: formData.phone,
                idCard: formData.idCard,
                privacySettings: DEFAULT_PRIVACY_SETTINGS,
                isOnline: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(user.uid).set(userData);
            document.getElementById('registerDriverModal').classList.remove('open');
            notificationManager.show('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + formData.name + '! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            if (userLatLng) {
                await activateDriverImmediately(user.uid, userLatLng);
            }
            if (map) setTimeout(() => loadActiveUsersOnMap(), 2000);
        } catch (error) {
            let msg = error.message;
            if (error.code === 'auth/email-already-in-use') msg = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
            else if (error.code === 'auth/weak-password') msg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
            else if (error.code === 'auth/invalid-email') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
            notificationManager.show('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', msg, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    async function registerUser() {
        const btn = document.getElementById('submitUserRegister');
        const originalText = btn.innerHTML;
        try {
            const formData = {
                name: document.getElementById('regUserName').value.trim(),
                email: document.getElementById('regUserEmail').value.trim(),
                password: document.getElementById('regUserPassword').value
            };
            const err = validateUserRegistration(formData);
            if (err) throw new Error(err);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
            const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
            const user = userCredential.user;
            const userData = {
                uid: user.uid,
                name: formData.name,
                email: formData.email,
                role: 'user',
                privacySettings: DEFAULT_PRIVACY_SETTINGS,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(user.uid).set(userData);
            document.getElementById('registerUserModal').classList.remove('open');
            notificationManager.show('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + formData.name + '! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­.', 'success');
        } catch (error) {
            let msg = error.message;
            if (error.code === 'auth/email-already-in-use') msg = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
            else if (error.code === 'auth/weak-password') msg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
            else if (error.code === 'auth/invalid-email') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
            notificationManager.show('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', msg, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    async function activateDriverImmediately(uid, loc = userLatLng || { latitude: 18.0859, longitude: -15.9707 }) {
        try {
            await db.collection('users').doc(uid).update({
                isOnline: true,
                location: {
                    latitude: loc.latitude,
                    longitude: loc.longitude,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }
            });
        } catch (error) {
            console.error('ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ:', error);
        }
    }
    function initializeRegistrationEventListeners() {
      document.getElementById('registerDriverBtn')?.addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('registerDriverModal').classList.add('open');
        setTimeout(() => document.getElementById('regDriverName').focus(), 300);
      });
      document.getElementById('registerUserBtn')?.addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('registerUserModal').classList.add('open');
        setTimeout(() => document.getElementById('regUserName').focus(), 300);
      });
      document.getElementById('submitDriverRegister')?.addEventListener('click', e => { e.preventDefault(); registerDriver(); });
      document.getElementById('submitUserRegister')?.addEventListener('click', e => { e.preventDefault(); registerUser(); });
      document.getElementById('closeRegisterDriverModal')?.addEventListener('click', () => document.getElementById('registerDriverModal').classList.remove('open'));
      document.getElementById('closeRegisterUserModal')?.addEventListener('click', () => document.getElementById('registerUserModal').classList.remove('open'));
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          document.getElementById('registerDriverModal')?.classList.remove('open');
          document.getElementById('registerUserModal')?.classList.remove('open');
        }
      });
    }
    function initializeLocationButton() {
      document.getElementById('allowBtn')?.addEventListener('click', async function() {
        const btn = this;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
        try {
          await enableLocationAndInitMap();
        } catch (error) {
          notificationManager.show('Ø®Ø·Ø£', error.message, 'error');
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      });
    }
    function initializeRequestButton() {
      document.getElementById('requestBtn')?.addEventListener('click', async function() {
        if (!isLocationEnabled) return notificationManager.show('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ', 'error');
        if (!map) await enableLocationAndInitMap();
        setTimeout(() => { if (map) map.invalidateSize(); }, 100);
        loadingManager.show('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚...');
        try {
          const nearestDriver = await findNearestDriver();
          if (nearestDriver) {
            smoothPanTo(nearestDriver.location);
            setTimeout(() => {
              showUserInfoCard(nearestDriver, nearestDriver.distanceKm);
            }, 800);
            notificationManager.show('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±', `ÙˆØ¬Ø¯Ù†Ø§ Ø³Ø§Ø¦Ù‚Ø§Ù‹ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${nearestDriver.distanceKm.toFixed(1)} ÙƒÙ…`, 'success');
          } else {
            notificationManager.show('Ù„Ø§ Ø³Ø§Ø¦Ù‚ÙŠÙ†', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ:', error);
          notificationManager.show('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨', 'error');
        } finally {
          loadingManager.hide();
        }
      });
    }
    function initializeEventListeners() {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.getElementById('menuToggle');
      if (menuToggle && sidebar) {
        menuToggle.addEventListener('click', e => {
          e.preventDefault(); e.stopPropagation();
          sidebar.classList.toggle('open');
          document.getElementById('userInfoCard').style.display = 'none';
        });
        document.addEventListener('click', () => sidebar.classList.remove('open'));
        sidebar.addEventListener('click', e => e.stopPropagation());
      }
      document.getElementById('loginBtn')?.addEventListener('click', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return notificationManager.show('Ø®Ø·Ø£', 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        loadingManager.show('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        try {
          await auth.signInWithEmailAndPassword(email, password);
          notificationManager.show('Ù…Ø±Ø­Ø¨Ø§Ù‹', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
          sidebar.classList.remove('open');
        } catch (error) {
          let msg = 'ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
          if (error.code === 'auth/user-not-found') msg = 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
          else if (error.code === 'auth/wrong-password') msg = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
          else if (error.code === 'auth/too-many-requests') msg = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹';
          notificationManager.show('Ø®Ø·Ø£', msg, 'error');
        } finally { loadingManager.hide(); }
      });
      document.getElementById('logoutBtn')?.addEventListener('click', async function() {
        try {
          loadingManager.show('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...');
          if (trackingInterval) { navigator.geolocation.clearWatch(trackingInterval); trackingInterval = null; }
          const user = auth.currentUser;
          if (user && (await db.collection('users').doc(user.uid).get()).data()?.role === 'driver') {
            await db.collection('users').doc(user.uid).update({ isOnline: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
          }
          await auth.signOut();
          notificationManager.show('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
          document.getElementById('chatModal')?.classList.remove('open');
          document.getElementById('userInfoCard').style.display = 'none';
        } catch (error) {
          notificationManager.show('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
        } finally { loadingManager.hide(); }
      });
      document.getElementById('startTrackingBtn')?.addEventListener('click', async function() {
        const user = auth.currentUser;
        if (!user) return notificationManager.show('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        loadingManager.show('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...');
        try {
          const userData = await checkUserPermission('driver');
          await db.collection('users').doc(user.uid).update({ 
            isOnline: true,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById('startTrackingBtn').textContent = 'ğŸ“ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…ÙØ¹Ù„';
          document.getElementById('startTrackingBtn').style.background = '#4CAF50';
          document.getElementById('startTrackingBtn').disabled = true;
          notificationManager.show('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„', 'ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¸Ø§Ù‡Ø± Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†', 'success');
        } catch (error) {
          notificationManager.show('Ø®Ø·Ø£', error.message, 'error');
        } finally { loadingManager.hide(); }
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          document.getElementById('chatModal')?.classList.remove('open');
          document.getElementById('userInfoCard').style.display = 'none';
        }
      });
      document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
      messageInput.addEventListener('input', debounce(() => {
        if (currentChatRoom && messageInput.value.trim()) {
          chatManager.typingIndicator(currentChatRoom, true);
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => chatManager.typingIndicator(currentChatRoom, false), 3000);
        }
      }, 500));
      messageInput.addEventListener('blur', () => {
        if (currentChatRoom) chatManager.typingIndicator(currentChatRoom, false);
      });
      document.getElementById('closeChat').addEventListener('click', () => {
        document.getElementById('chatModal').classList.remove('open');
        if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
        currentChatRoom = null; currentChatPartner = null;
        if (typingTimeout) clearTimeout(typingTimeout);
      });
      document.getElementById('chatToggleBtn').addEventListener('click', async () => {
        if (!auth.currentUser) {
          notificationManager.show('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
          return;
        }
        const lastChat = await getLastChat();
        if (lastChat) {
          openChatByRoomId(lastChat.roomId);
        } else {
          const nearest = await findNearestDriver();
          if (nearest) {
            openChatWithUser(nearest);
          } else {
            notificationManager.show('Ù„Ø§ Ù…Ø­Ø§Ø¯Ø«Ø§Øª', 'Ù„Ù… ØªÙØ¬Ø±Ù Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø¹Ø¯ØŒ ÙˆØ³ÙŠØªÙ… ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯', 'info');
          }
        }
      });
      const card = document.getElementById('userInfoCard');
      card.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('click', () => {
        card.style.display = 'none';
      });
    }
    async function getLastChat() {
      if (!auth.currentUser) return null;
      const uid = auth.currentUser.uid;
      const chatsSnapshot = await db.collection('chats')
        .where('participants', 'array-contains', uid)
        .orderBy('lastActivity', 'desc')
        .limit(1)
        .get();
      if (chatsSnapshot.empty) return null;
      const chatDoc = chatsSnapshot.docs[0];
      const chatData = chatDoc.data();
      const roomId = chatDoc.id;
      const otherUid = chatData.participants.find(id => id !== uid);
      if (!otherUid) return null;
      const partnerDoc = await db.collection('users').doc(otherUid).get();
      if (!partnerDoc.exists) return null;
      const partner = partnerDoc.data();
      return {
        roomId,
        partner
      };
    }
    async function openChatByRoomId(roomId) {
      if (!auth.currentUser) return;
      const uid = auth.currentUser.uid;
      const chatDoc = await db.collection('chats').doc(roomId).get();
      if (!chatDoc.exists) return;
      const chatData = chatDoc.data();
      const otherUid = chatData.participants.find(id => id !== uid);
      if (!otherUid) return;
      const partnerDoc = await db.collection('users').doc(otherUid).get();
      if (!partnerDoc.exists) return;
      const partner = partnerDoc.data();
      currentChatPartner = partner;
      currentChatRoom = roomId;
      document.getElementById('chatPartnerName').textContent = partner.name || '---';
      document.getElementById('chatPartnerInfo').textContent = `${partner.role === 'driver' ? 'Ø³Ø§Ø¦Ù‚' : 'Ø²Ø¨ÙˆÙ†'} - ${partner.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§ØªÙ'}`;
      document.getElementById('chatMessages').innerHTML = '<div style="text-align:center;color:#888;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      if (chatUnsubscribe && typeof chatUnsubscribe === 'function') {
        chatUnsubscribe();
      }
      chatUnsubscribe = db.collection('chats').doc(roomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot({ includeMetadataChanges: true }, (snapshot) => {
          if (snapshot.metadata.fromCache || snapshot.metadata.hasPendingWrites) return;
          renderMessages(snapshot.docs);
          markMessagesAsRead();
        });
      db.collection('chats').doc(roomId).onSnapshot((doc) => {
        const data = doc.data();
        if (data && data.typing) {
          const typingUsers = Object.entries(data.typing)
            .filter(([u, isTyping]) => u !== uid && isTyping);
          if (typingUsers.length > 0) {
            document.getElementById('typingUserName').textContent = partner.name;
            document.getElementById('typingIndicator').style.display = 'block';
          } else {
            document.getElementById('typingIndicator').style.display = 'none';
          }
        }
      });
      document.getElementById('chatModal').classList.add('open');
      document.getElementById('messageInput').focus();
      document.getElementById('chatToggleBtn').classList.remove('has-unread');
      document.getElementById('chatBadgeCount').style.display = 'none';
    }
    document.addEventListener('DOMContentLoaded', function() {
      console.log('âœ… ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Mosaver...');
      initializeNotificationSound();
      initializeRegistrationEventListeners();
      initializeLocationButton();
      initializeRequestButton();
      initializeEventListeners();
      auth.onAuthStateChanged(async (user) => {
        const authSec = document.getElementById('authSection');
        const profSec = document.getElementById('userProfileSection');
        if (user) {
          authSec.style.display = 'none';
          profSec.style.display = 'block';
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            if (!userData) { await auth.signOut(); return; }
            updateUIBasedOnRole(userData);
            if (document.getElementById('mapContainer').style.display === 'block') await loadActiveUsersOnMap();
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            notificationManager.show('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
          }
        } else {
          authSec.style.display = 'block';
          profSec.style.display = 'none';
          document.getElementById('chatToggleBtn').style.display = 'none';
          document.getElementById('controlBtns').style.display = 'none';
          if (trackingInterval) { navigator.geolocation.clearWatch(trackingInterval); trackingInterval = null; }
          isLocationEnabled = false;
        }
      });
      db.collection('users').onSnapshot((snapshot) => {
        if (auth.currentUser && document.getElementById('mapContainer').style.display === 'block') {
          setTimeout(() => loadActiveUsersOnMap(), 2000);
        }
      });
      setTimeout(() => { document.body.style.opacity = '1'; }, 100);
    });
  </script>
</body>
</html>
